<h1>Edit Room</h1>

<%= form_with model: @room, local: true do |form| %>
  <div>
    <%=  form.label :name %>
    <%= form.text_field :name %>
  </div>

  <div>
    <%= form.label :description %>
    <%= form.text_area :description %>
  </div>

  <%= form.hidden_field :floor_plan, value: "{ \"arrays\": #{@matrix} }", id: "matrix_data_field" %>

  <br>
  <br>

  <div id="doorways-container">
    <!-- Doorways will be added here dynamically -->
  </div>

  <!-- Hidden container for doorway form fields -->
  <div id="doorway-fields-container">
    <!-- Doorway hidden fields will be added here -->
  </div>

  <button type="button" id="doorwayButton" onclick="addDoorwayField()" class="matrix-button">Add Doorway</button>

  <br>
  <br>

  <div>
    <%= form.submit "Save Changes" %>
  </div>
<% end %>

<a href="<%= room_path(@room) %>">Cancel</a>

<br>
<br>

<div class="matrix-container" style="border: 2px solid #333; padding: 10px; display: inline-block;">
  <div id="matrix-grid" class="matrix-grid" style="display: grid; grid-template-columns: repeat(<%= @matrix[0].size %>, 50px); gap: 5px;">
    <% @matrix.each_with_index do |row, row_index| %>
      <% row.each_with_index do |cell, col_index| %>
        <div class="square" data-row="<%= row_index %>" data-col="<%= col_index %>" style="width: 50px; height: 50px; background-color: <%= cell == 1 ? '#ffffff' : '#000000' %>;" onclick="toggleSquare(this)"></div>
      <% end %>
    <% end %>
  </div>
</div>

<div class="matrix-controls" style="margin-bottom: 10px;">
  <button type="button" id="rowButton" onclick="handleRowAction()" class="matrix-button">Add Row</button>
  <button type="button" id="colButton" onclick="handleColumnAction()" class="matrix-button">Add Column</button>

  <div class="toggle-container" style="margin-bottom: 10px;">
    <input type="checkbox" id="deleteMode" onchange="updateButtonLabels()">
    <label for="deleteMode">Delete Mode</label>
  </div>
</div>

<script>
  var matrix = <%= @matrix.to_json %>
  var doorwayCount = 0;

  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("matrix_data_field").value = JSON.stringify({ arrays: matrix });
  });

  function addDoorwayField() {
    const doorwaysContainer = document.getElementById('doorways-container');
    const doorwayFieldsContainer = document.getElementById('doorway-fields-container');
    const doorwayId = doorwayCount++;


    // Create visual doorway input fields
    const doorwayDiv = document.createElement('div');
    doorwayDiv.className = 'doorway-field';
    doorwayDiv.id = `doorway-${doorwayId}`;
    doorwayDiv.style.marginBottom = '15px';

    // Create the doorway type dropdown
    const selectLabel = document.createElement('label');
    selectLabel.textContent = 'Doorway kind: ';

    const select = document.createElement('select');
    select.id = `doorway_kind_visible_${doorwayId}`;
    select.onchange = function() { updateDoorwayHiddenFields(doorwayId); };

    const option1 = document.createElement('option');
    option1.value = 'standard';
    option1.textContent = 'Standard';

    const option2 = document.createElement('option');
    option2.value = 'arch';
    option2.textContent = 'Arch';

    const option3 = document.createElement('option');
    option3.value = 'hidden';
    option3.textContent = 'Hidden';

    select.appendChild(option1);
    select.appendChild(option2);
    select.appendChild(option3);

    // Create the description field
    const descLabel = document.createElement('label');
    descLabel.textContent = ' Description: ';
    descLabel.style.marginLeft = '10px';

    const descInput = document.createElement('input');
    descInput.type = 'text';
    descInput.id = `doorway_description_visible_${doorwayId}`;
    descInput.placeholder = 'Enter doorway description';
    descInput.onchange = function() { updateDoorwayHiddenFields(doorwayId); };
    descInput.onkeyup = function() { updateDoorwayHiddenFields(doorwayId); };

    const lockedLabel = document.createElement('label');
    lockedLabel.textContent = ' Locked? ';
    lockedLabel.style.marginLeft = '10px';

    const lockedChecked = document.createElement('input');
    lockedChecked.type = 'checkbox';
    lockedChecked.value = 'true'
    lockedChecked.id = `doorway_locked_visible_${doorwayId}`;
    lockedChecked.onclick = function() { this.value = this.checked };
    lockedChecked.onchange = function() { updateDoorwayHiddenFields(doorwayId);};

    // Create remove button
    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.textContent = 'Remove';
    removeButton.className = 'remove-doorway-button';
    removeButton.onclick = function() { removeDoorway(doorwayId); };
    removeButton.style.marginLeft = '10px';

    // Append all elements to the doorway div
    doorwayDiv.appendChild(selectLabel);
    doorwayDiv.appendChild(select);
    doorwayDiv.appendChild(descLabel);
    doorwayDiv.appendChild(descInput);
    doorwayDiv.appendChild(lockedLabel);
    doorwayDiv.appendChild(lockedChecked);
    doorwayDiv.appendChild(removeButton);

    // Append the doorway div to the container
    doorwaysContainer.appendChild(doorwayDiv);

    // Create hidden form fields for this doorway
    const kindHiddenField = document.createElement('input');
    kindHiddenField.type = 'hidden';
    kindHiddenField.name = `doorways[${doorwayId}][kind]`;
    kindHiddenField.id = `doorway_kind_${doorwayId}`;
    kindHiddenField.value = 'standard'; // Default value

    const descHiddenField = document.createElement('input');
    descHiddenField.type = 'hidden';
    descHiddenField.name = `doorways[${doorwayId}][description]`;
    descHiddenField.id = `doorway_description_${doorwayId}`;
    descHiddenField.value = '';

    const lockedHiddenField = document.createElement('input');
    lockedHiddenField.type = 'hidden';
    lockedHiddenField.name = `doorways[${doorwayId}][locked]`;
    lockedHiddenField.id = `doorway_locked_${doorwayId}`;
    lockedHiddenField.value = 'false';

    doorwayFieldsContainer.appendChild(kindHiddenField);
    doorwayFieldsContainer.appendChild(descHiddenField);
    doorwayFieldsContainer.appendChild(lockedHiddenField);
  }

  function updateDoorwayHiddenFields(id) {
    const kindVisible = document.getElementById(`doorway_kind_visible_${id}`);
    const descVisible = document.getElementById(`doorway_description_visible_${id}`);
    const lockedVisible = document.getElementById(`doorway_locked_visible_${id}`);
    const kindHidden = document.getElementById(`doorway_kind_${id}`);
    const descHidden = document.getElementById(`doorway_description_${id}`);
    const lockedHidden = document.getElementById(`doorway_locked_${id}`);


    if (kindVisible && kindHidden) {
      kindHidden.value = kindVisible.value;
    }

    if (descVisible && descHidden) {
      descHidden.value = descVisible.value;
    }

    console.log()
    if (lockedVisible && lockedHidden) {
      lockedHidden.value = lockedVisible.value;
    }
  }

  function removeDoorway(id) {
    // Remove visual element
    const doorwayElement = document.getElementById(`doorway-${id}`);
    if (doorwayElement) {
      doorwayElement.remove();
    }

    // Remove hidden fields
    const kindHidden = document.getElementById(`doorway_kind_${id}`);
    const descHidden = document.getElementById(`doorway_description_${id}`);

    if (kindHidden) kindHidden.remove();
    if (descHidden) descHidden.remove();
  }

  function updateButtonLabels() {
    const deleteMode = document.getElementById('deleteMode').checked;
    const rowButton = document.getElementById('rowButton');
    const colButton = document.getElementById('colButton');

    if (deleteMode) {
      rowButton.textContent = 'Delete Row';
      rowButton.classList.add('delete-mode');
      colButton.textContent = 'Delete Column';
      colButton.classList.add('delete-mode');
    } else {
      rowButton.textContent = 'Add Row';
      rowButton.classList.remove('delete-mode');
      colButton.textContent = 'Add Column';
      colButton.classList.remove('delete-mode');
    }
  }

  function handleRowAction() {
    const deleteMode = document.getElementById('deleteMode').checked;
    if (deleteMode) {
      deleteRow();
    } else {
      addRow();
    }
  }

  function handleColumnAction() {
    const deleteMode = document.getElementById('deleteMode').checked;
    if (deleteMode) {
      deleteColumn();
    } else {
      addColumn();
    }
  }

  function toggleSquare(square) {
    const row = square.getAttribute('data-row');
    const column = square.getAttribute('data-col');
    matrix[row][column] = matrix[row][column] == 0 ? 1 : 0;

    const currentColor = square.style.backgroundColor;
    square.style.backgroundColor = (currentColor === 'rgb(0, 0, 0)') ? '#ffffff' : '#000000';

    updateHiddenField();
  }

  function addRow() {
    const numCols = matrix[0].length;

    const newRow = Array(numCols).fill(0);

    matrix.push(newRow);

    redrawGrid();

    updateHiddenField();
  }

  function deleteRow() {
    if (matrix.length <= 1) {
      alert("Cannot delete the last row!");
      return;
    }

    matrix.pop();

    redrawGrid();

    updateHiddenField();
  }

  function addColumn() {
    for (let i = 0; i < matrix.length; i++) {
      matrix[i].push(0);
    }

    redrawGrid();

    updateHiddenField();
  }

  function deleteColumn() {
    if (matrix[0].length <= 1) {
      alert("Cannot delete the last column!");
      return;
    }

    for (let i = 0; i < matrix.length; i++) {
      matrix[i].pop();
    }

    redrawGrid();

    updateHiddenField();
  }

  function redrawGrid() {
    const gridElement = document.getElementById('matrix-grid');

    gridElement.style.gridTemplateColumns = `repeat(${matrix[0].length}, 50px)`;

    gridElement.innerHTML = '';

    for (let rowIndex = 0; rowIndex < matrix.length; rowIndex++) {
      for (let colIndex = 0; colIndex < matrix[rowIndex].length; colIndex++) {
        const square = document.createElement('div');
        square.className = 'square';
        square.setAttribute('data-row', rowIndex);
        square.setAttribute('data-col', colIndex);
        square.style.width = '50px';
        square.style.height = '50px';
        square.style.backgroundColor = matrix[rowIndex][colIndex] == 1 ? '#ffffff' : '#000000';
        square.onclick = function() { toggleSquare(this); };

        gridElement.appendChild(square);
      }
    }
  }

  function updateHiddenField() {
    document.getElementById("matrix_data_field").value = JSON.stringify({ arrays: matrix });
  }
</script>

<style>
  .matrix-grid {
    margin: 20px auto;
  }
  .square {
    border: 1px solid #ccc;
    cursor: pointer;
  }
  .matrix-button {
    padding: 8px 16px;
    margin-right: 10px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .matrix-button:hover {
    background-color: #45a049;
  }
  .delete-mode {
    background-color: #f44336;
  }
  .delete-mode:hover {
    background-color: #d32f2f;
  }
  .toggle-container {
    margin-bottom: 10px;
  }
  .toggle-container input[type="checkbox"] {
    margin-right: 5px;
  }
  .doorway-field {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #f9f9f9;
  }
  .remove-doorway-button {
    padding: 5px 10px;
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .remove-doorway-button:hover {
    background-color: #d32f2f;
  }
</style>
